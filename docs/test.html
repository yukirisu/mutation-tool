<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>構造アラインメントビューア</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- NGL.js -->
  <script src="https://cdn.jsdelivr.net/npm/ngl@2.0.0-dev.37/dist/ngl.js"></script>
  <!-- JSZip（ZIP一括DL用） -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    :root{ --bg:#ffffff; --fg:#111; --muted:#6b7280; --accent:#2563eb; --border:#e5e7eb; }
    *{ box-sizing:border-box; } html,body{ height:100%; }
    body{ margin:0; background:var(--bg); color:var(--fg);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif; }
    .taskbar{ position:sticky; top:0; z-index:50; background:var(--bg);
      border-bottom:1px solid var(--border); padding:8px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:8px;}
    .brand{ font-weight:700; } .muted{ color:var(--muted); }
    .btn{ display:inline-flex; align-items:center; gap:6px;
      border:1px solid var(--border); background:#fff; color:#111;
      border-radius:8px; padding:8px 12px; cursor:pointer; font-weight:600; }
    .btn.primary{ background:var(--accent); color:#fff; border-color:var(--accent); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .switch{ display:inline-flex; align-items:center; gap:6px; color:var(--muted);
      padding:4px 8px; border-radius:8px; border:1px dashed var(--border); background:#fff; }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#fff; font-size:12px; }
    .badge.good{ border-color:#10b981; } .badge.warn{ border-color:#f59e0b; } .badge.err{ border-color:#ef4444; color:#b91c1c; }
    .sep{ width:1px; height:28px; background:var(--border); margin:0 4px; }
    .container{ max-width:1200px; margin:16px auto; padding:0 16px 48px; }
    h1{ font-size:20px; margin:16px 0 8px; } p.desc{ margin:0 0 12px; color:var(--muted); }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:16px; } @media (max-width:960px){ .grid{ grid-template-columns:1fr; } }
    .panel{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; }
    .stage{ width:100%; height:520px; border:1px solid var(--border); border-radius:12px; background:#fff; }
    table{ width:100%; border-collapse:collapse; font-size:14px; } th,td{ border:1px solid var(--border); padding:8px 10px; text-align:left; }
    tr:hover{ background:#f9fafb; } .err{ color:#b00020; font-weight:600; margin-top:6px; }
    input[type="file"]{ display:none; }
  </style>
</head>
<body>

  <!-- Taskbar -->
  <div class="taskbar">
    <div>
      <span class="brand">StructAlign</span>
      <span class="muted">— ブラウザ内・構造アラインメント</span>
      <span id="statusBadge" class="badge">Ready</span>
    </div>
    <div>
      <input type="file" id="pdb_template" accept=".pdb" />
      <input type="file" id="pdb_files" accept=".pdb" multiple />
      <button class="btn" id="btnPickTemplate">テンプレート選択</button>
      <button class="btn" id="btnPickInputs">対象ファイル選択</button>
      <label class="switch"><input type="checkbox" id="folderMode" /> <span>フォルダを選ぶ</span></label>
      <span class="sep"></span>
      <button class="btn primary" id="btnRun">アラインメント実行</button>
      <button class="btn" id="btnDownloadAll" disabled>一括DL (ZIP)</button>
      <button class="btn" id="btnDemo">デモ</button>
      <button class="btn" id="btnClear">表示クリア</button>
    </div>
  </div>

  <div class="container">
    <h1>構造アラインメント（配列は不使用）</h1>
    <p class="desc">テンプレートPDB 1件と複数PDB（ファイル/フォルダ）をローカルで読み込み、Kabsch法で重ね合わせします。データは外部送信されません。</p>

    <div class="grid">
      <div class="panel">
        <h3 style="margin:0 0 8px;">テンプレート</h3>
        <div id="stageT" class="stage"></div>
      </div>
      <div class="panel">
        <h3 style="margin:0 0 8px;">アライン後（対象）</h3>
        <div id="stageM" class="stage"></div>
      </div>
    </div>

    <div class="panel" style="margin-top:16px;">
      <h3 style="margin:0 0 8px;">結果</h3>
      <div class="muted" style="margin-bottom:8px;">
        <span>マッチ数: <b id="matched">0</b></span>
        <span style="margin-left:12px;">RMSD (Å): <b id="rmsd">–</b></span>
      </div>
      <div id="err" class="err"></div>
      <div style="overflow:auto;">
        <table>
          <thead><tr><th>ファイル</th><th>RMSD(Å)</th><th>操作</th></tr></thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    /* ===== Global state ===== */
    const stageT = new NGL.Stage("stageT", { backgroundColor: "#ffffff" });
    const stageM = new NGL.Stage("stageM", { backgroundColor: "#ffffff" });
    const statusBadge = document.getElementById("statusBadge");

    let ID_SEQ = 0;
    const STORE = new Map(); // id -> {name, text, rmsd, count}
    let lastPreviewId = null;

    function setStatus(text, type=""){ statusBadge.textContent = text; statusBadge.className = "badge " + (type||""); }
    function showError(msg){ document.getElementById("err").textContent = msg || ""; setStatus(msg ? "Error" : "Ready", msg ? "err" : ""); }
    function safeZipPath(name){ return name.replace(/[\\:*?"<>|]/g, "_"); }
    function safeFileName(name){ return name.replace(/[\\/:*?"<>|]/g, "_"); }
    function updateBulkButton(){ document.getElementById("btnDownloadAll").disabled = (STORE.size === 0); }

    /* ===== File pickers ===== */
    const inpTemplate = document.getElementById("pdb_template");
    const inpFiles    = document.getElementById("pdb_files");
    const chkFolder   = document.getElementById("folderMode");
    const tbody       = document.getElementById("resultsBody");

    document.getElementById("btnPickTemplate").addEventListener("click", ()=> inpTemplate.click());
    document.getElementById("btnPickInputs").addEventListener("click", ()=> inpFiles.click());
    chkFolder.addEventListener("change", ()=>{
      if(chkFolder.checked){ inpFiles.setAttribute("webkitdirectory",""); inpFiles.removeAttribute("multiple"); }
      else{ inpFiles.removeAttribute("webkitdirectory"); inpFiles.setAttribute("multiple",""); }
      inpFiles.value = "";
    });
    inpTemplate.addEventListener("change", ()=>{
      if(inpTemplate.files.length){
        setStatus(`Template: ${inpTemplate.files[0].name}`,"good");
        loadTextFile(inpTemplate.files[0]).then(t=> renderPDB(stageT, t, "#2196f3"));
      } else setStatus("Ready");
    });
    inpFiles.addEventListener("change", ()=>{
      const n = Array.from(inpFiles.files||[]).filter(f=>/\.pdb$/i.test(f.name)).length;
      setStatus(n>0?`Targets: ${n} files`:"Ready", n>0?"good":"");
    });

    document.getElementById("btnRun").addEventListener("click", alignSubmit);
    document.getElementById("btnClear").addEventListener("click", ()=>{
      stageT.removeAllComponents(); stageM.removeAllComponents();
      tbody.innerHTML = ""; STORE.clear(); ID_SEQ=0;
      document.getElementById("matched").textContent="0"; document.getElementById("rmsd").textContent="–";
      lastPreviewId=null; showError(""); setStatus("Cleared"); updateBulkButton();
    });
    document.getElementById("btnDemo").addEventListener("click", runDemo);
    document.getElementById("btnDownloadAll").addEventListener("click", downloadAllZip);

    // イベント委譲：結果テーブルのボタン
    tbody.addEventListener("click", async (ev)=>{
      const btn = ev.target.closest("button"); if(!btn) return;
      const id = btn.getAttribute("data-id"); if(!id || !STORE.has(id)) return;
      if(btn.classList.contains("btn-show")){ await previewId(id); }
      if(btn.classList.contains("btn-dl"))  { downloadId(id); }
    });

    /* ===== Core: Alignment ===== */
    async function alignSubmit(){
      try{
        showError("");
        if(!inpTemplate.files.length){ showError("テンプレートPDBを選択してください"); return; }
        if(!inpFiles.files.length){ showError("アライン対象（ファイル/フォルダ）を選択してください"); return; }

        setStatus("Running...","warn");
        const tmplText = await loadTextFile(inpTemplate.files[0]);
        const atomsT = parsePDB(tmplText);
        await renderPDB(stageT, tmplText, "#2196f3");

        STORE.clear(); ID_SEQ=0; tbody.innerHTML = "";
        const files = Array.from(inpFiles.files||[]).filter(f=>/\.pdb$/i.test(f.name));

        for(const f of files){
          const text = await loadTextFile(f);
          const atomsM = parsePDB(text);
          const {rmsd, transformed, count} = alignKabschSimple(atomsT, atomsM);
          const display = (f.webkitRelativePath && f.webkitRelativePath.length) ? f.webkitRelativePath : f.name;
          const id = "k"+(++ID_SEQ);
          STORE.set(id, {name: display, text: transformed, rmsd, count});

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${display}</td>
            <td>${Number.isFinite(rmsd) ? rmsd.toFixed(3) : "—"}</td>
            <td style="display:flex; gap:8px;">
              <button class="btn btn-dl"   type="button" data-id="${id}">DL</button>
              <button class="btn btn-show" type="button" data-id="${id}">表示</button>
            </td>`;
          tbody.appendChild(tr);

          if (STORE.size === 1){
            await previewId(id);
            document.getElementById("matched").textContent = count;
            document.getElementById("rmsd").textContent = Number.isFinite(rmsd) ? rmsd.toFixed(3) : "—";
          }
        }
        setStatus("Done","good"); updateBulkButton();
      }catch(e){
        console.error(e); showError("実行時エラー: " + (e && e.message ? e.message : e));
      }
    }

    /* ===== File & Viewer ===== */
    function loadTextFile(file){
      return new Promise((resolve,reject)=>{
        const fr = new FileReader(); fr.onload = ()=>resolve(fr.result); fr.onerror=reject; fr.readAsText(file);
      });
    }
    function renderPDB(stage, pdbText, colorHex){
      stage.removeAllComponents();
      const blob = new Blob([pdbText], {type:"chemical/x-pdb"});
      return stage.loadFile(blob, {ext:"pdb"}).then(o=>{
        // ★ colorValue を使い、確実に単色指定（'color' ではなく）
        o.addRepresentation("cartoon", { colorValue: colorHex });
        o.autoView();
      }).catch(err=>{
        console.error(err);
        showError("表示に失敗しました（NGLの読み込みに失敗）");
      });
    }

    async function previewId(id){
      const item = STORE.get(id); if(!item) return;
      await renderPDB(stageM, item.text, "#ef4444");
      lastPreviewId = id;
    }
    function downloadId(id){
      const item = STORE.get(id); if(!item){ alert("アライン後PDBが見つかりません"); return; }
      const blob = new Blob([item.text], {type:"chemical/x-pdb"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      const base = safeFileName(item.name.endsWith(".pdb") ? item.name.slice(0,-4) : item.name);
      a.download = `${base}_aligned.pdb`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(a.href);
    }
    async function downloadAllZip(){
      if(STORE.size===0){ alert("ダウンロード対象がありません"); return; }
      setStatus("Zipping...","warn");
      const zip = new JSZip();
      for(const [,item] of STORE){
        const pathInZip = safeZipPath(item.name.endsWith(".pdb") ? item.name.slice(0,-4) : item.name) + "_aligned.pdb";
        zip.file(pathInZip, item.text);
      }
      const blob = await zip.generateAsync({type:"blob"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "aligned_structures.zip";
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(a.href);
      setStatus("ZIP Ready","good");
    }

    /* ===== PDB parsing ===== */
    function parsePDB(text){
      const atoms=[]; const lines = text.split(/\r?\n/);
      for(const line of lines){
        if(!line) continue;
        if(line.startsWith("ATOM") || line.startsWith("HETATM")){
          const name = line.slice(12,16).trim();
          const x = parseFloat(line.slice(30,38));
          const y = parseFloat(line.slice(38,46));
          const z = parseFloat(line.slice(46,54));
          atoms.push({ name, x, y, z, line });
        }
      }
      return atoms;
    }

    /* ===== Alignment (Kabsch, simple pairing) =====
       座標欄(30–54桁)のみ上書きし、それ以外は元の行を完全維持
    */
    function alignKabschSimple(refAtoms, mobAtoms){
      const n = Math.min(refAtoms.length, mobAtoms.length);
      if(n < 3){
        return { rmsd: Number.NaN, transformed: mobAtoms.map(a=>a.line).join("\n"), count: n };
      }
      const P = new Array(n), Q = new Array(n);
      for(let i=0;i<n;i++){ P[i]=[refAtoms[i].x,refAtoms[i].y,refAtoms[i].z]; Q[i]=[mobAtoms[i].x,mobAtoms[i].y,mobAtoms[i].z]; }
      const Pc = mean(P), Qc = mean(Q);
      const X = subAll(P, Pc), Y = subAll(Q, Qc);
      const H = mulT(X, Y);
      const {U,S,V} = svdJacobi(H);
      let R = mul(V, tr(U));
      if (det3(R) < 0){ V[0][2]*=-1; V[1][2]*=-1; V[2][2]*=-1; R = mul(V, tr(U)); }
      const t = subV(Qc, mv(R, Pc));
      const MT = addAll(mulAll(X, R), t);
      const r = rms(MT, Y);

      const out = [];
      for(let i=0;i<mobAtoms.length;i++){
        const a = mobAtoms[i];
        if(i < n){
          const nx = MT[i][0].toFixed(3).toString().padStart(8,' ');
          const ny = MT[i][1].toFixed(3).toString().padStart(8,' ');
          const nz = MT[i][2].toFixed(3).toString().padStart(8,' ');
          let line = a.line;
          line = line.substring(0,30) + nx + ny + nz + line.substring(54);
          out.push(line);
        } else { out.push(a.line); }
      }
      out.push("END");
      return { rmsd:r, transformed: out.join("\n"), count:n };
    }

    /* ===== Math helpers & SVD ===== */
    function mean(P){ const n=P.length; return [0,1,2].map(j=>P.reduce((s,p)=>s+p[j],0)/n); }
    function subV(a,b){ return [a[0]-b[0], a[1]-b[1], a[2]-b[2]]; }
    function mv(A,v){ return [A[0][0]*v[0]+A[0][1]*v[1]+A[0][2]*v[2], A[1][0]*v[0]+A[1][1]*v[1]+A[1][2]*v[2], A[2][0]*v[0]+A[2][1]*v[1]+A[2][2]*v[2]]; }
    function subAll(P,c){ return P.map(p=>[p[0]-c[0], p[1]-c[1], p[2]-c[2]]); }
    function addAll(P,c){ return P.map(p=>[p[0]+c[0], p[1]+c[1], p[2]+c[2]]); }
    function tr(A){ return A[0].map((_,i)=>A.map(r=>r[i])); }
    function mul(A,B){ const r=A.length,c=B[0].length,k=B.length; const o=Array.from({length:r},()=>Array(c).fill(0));
      for(let i=0;i<r;i++) for(let j=0;j<c;j++) for(let t=0;t<k;t++) o[i][j]+=A[i][t]*B[t][j]; return o; }
    function mulT(X,Y){ return mul(tr(X),Y); }
    function mulAll(P,R){ return P.map(v=>[R[0][0]*v[0]+R[0][1]*v[1]+R[0][2]*v[2], R[1][0]*v[0]+R[1][1]*v[1]+R[1][2]*v[2], R[2][0]*v[0]+R[2][1]*v[1]+R[2][2]*v[2]]); }
    function det3(M){ return M[0][0]*(M[1][1]*M[2][2]-M[1][2]*M[2][1]) - M[0][1]*(M[1][0]*M[2][2]-M[1][2]*M[2][0]) + M[0][2]*(M[1][0]*M[2][1]-M[1][1]*M[2][0]); }
    function rms(A,B){ let s=0; for(let i=0;i<A.length;i++){ const dx=A[i][0]-B[i][0], dy=A[i][1]-B[i][1], dz=A[i][2]-B[i][2]; s+=dx*dx+dy*dy+dz*dz; } return Math.sqrt(s/A.length); }

    function svdJacobi(M){
      function T(A){ return A[0].map((_,i)=>A.map(r=>r[i])); }
      function mul(A,B){ const r=A.length,c=B[0].length,k=B.length; const o=Array.from({length:r},()=>Array(c).fill(0));
        for(let i=0;i<r;i++) for(let j=0;j<c;j++) for(let t=0;t<k;t++) o[i][j]+=A[i][t]*B[t][j]; return o; }
      function ATA(A){ return mul(T(A),A); }
      function I(n){ return Array.from({length:n},(_,i)=>Array.from({length:n},(_,j)=>i===j?1:0)); }
      let AtA = ATA(M); const N=3; let V = I(N);
      for(let iter=0; iter<40; iter++){
        for(let p=0;p<N;p++) for(let q=p+1;q<N;q++){
          const app=AtA[p][p], aqq=AtA[q][q], apq=AtA[p][q];
          if(Math.abs(apq) < 1e-12) continue;
          const phi = 0.5*Math.atan2(2*apq, (aqq-app));
          const c=Math.cos(phi), s=Math.sin(phi);
          for(let k=0;k<N;k++){ const pk=AtA[p][k], qk=AtA[q][k]; AtA[p][k]=c*pk-s*qk; AtA[q][k]=s*pk+c*qk; }
          for(let k=0;k<N;k++){ const kp=AtA[k][p], kq=AtA[k][q]; AtA[k][p]=c*kp-s*kq; AtA[k][q]=s*kp+c*kq; }
          for(let k=0;k<N;k++){ const vk=V[k][p], wk=V[k][q]; V[k][p]=c*vk-s*wk; V[k][q]=s*vk+c*wk; }
        }
      }
      const S=[Math.sqrt(Math.max(AtA[0][0],0)), Math.sqrt(Math.max(AtA[1][1],0)), Math.sqrt(Math.max(AtA[2][2],0))];
      const U=I(3); return {U,S,V};
    }

    /* ===== Demo ===== */
    function runDemo(){
      const pdbT = [
        'ATOM      1  N   ALA A   1       0.000   0.000   0.000  1.00 20.00           N',
        'ATOM      2  CA  ALA A   1       1.458   0.000   0.000  1.00 20.00           C',
        'ATOM      3  C   ALA A   1       2.000   1.300   0.000  1.00 20.00           C',
        'ATOM      4  O   ALA A   1       1.500   2.300   0.000  1.00 20.00           O',
        'END'
      ].join('\n');
      const pdbM = [
        'ATOM      1  N   ALA A   1       3.000   0.500   0.200  1.00 20.00           N',
        'ATOM      2  CA  ALA A   1       4.458   0.500   0.200  1.00 20.00           C',
        'ATOM      3  C   ALA A   1       5.000   1.800   0.200  1.00 20.00           C',
        'ATOM      4  O   ALA A   1       4.500   2.800   0.200  1.00 20.00           O',
        'END'
      ].join('\n');

      renderPDB(stageT, pdbT, "#2196f3");
      const {rmsd, transformed, count} = alignKabschSimple(parsePDB(pdbT), parsePDB(pdbM));

      STORE.clear(); ID_SEQ=0;
      const id = "k"+(++ID_SEQ);
      STORE.set(id, {name:"demo_aligned.pdb", text: transformed, rmsd, count});
      document.getElementById("matched").textContent = count;
      document.getElementById("rmsd").textContent = Number.isFinite(rmsd) ? rmsd.toFixed(3) : "—";

      document.getElementById("resultsBody").innerHTML = `
        <tr>
          <td>demo_aligned.pdb</td>
          <td>${Number.isFinite(rmsd) ? rmsd.toFixed(3) : "—"}</td>
          <td style="display:flex; gap:8px;">
            <button class="btn btn-dl"   data-id="${id}">DL</button>
            <button class="btn btn-show" data-id="${id}">表示</button>
          </td>
        </tr>`;
      updateBulkButton();
      previewId(id);
      setStatus("Demo loaded","good");
    }
  </script>
</body>
</html>
